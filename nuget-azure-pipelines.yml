strategy:
  matrix:
    Windows-VS2019:
      imageName: 'vs2017-win2016'
      netcore_sdk: 3.1.201
      rustup_toolchain: nightly-2020-01-07
    Osx-Mojave:
      imageName: 'macos-10.14'
      netcore_sdk: 3.1.201
      rustup_toolchain: nightly-2020-01-07
    Ubuntu-1804:
      imageName: 'ubuntu-18.04'
      netcore_sdk: 3.1.201
      rustup_toolchain: nightly-2020-01-07
  maxParallel: 3

pool:
  vmImage: $(imageName)

steps:
  - task: DotNetCoreInstaller@0
    displayName: 'Install .NetCore SDK'
    inputs:
      version: 3.1.201
      failOnStandardError: 'true'
  - script: cargo build --manifest-path packages/catalyst-ffi/Cargo.toml --verbose
    displayName: Cargo build 
  - script: cargo test --manifest-path packages/catalyst-ffi/Cargo.toml --verbose
    displayName: Cargo test 
  - task: CopyFiles@2
    displayName: copy windows runtime
    condition: eq( variables['Agent.OS'], 'Windows_NT' )
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/packages/catalyst-ffi/target/debug'
      TargetFolder: '$./runtimes/win-x64/native'
      Contents: 'catalyst_ffi.*'
  - task: CopyFiles@2
    displayName: copy macos runtime
    condition: eq( variables['Agent.OS'], 'Darwin' )
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/packages/catalyst-ffi/target/debug'
      TargetFolder: '$./runtimes/osx-x64/native'
      Contents: 'libcatalyst_ffi.*'
  - task: CopyFiles@2
    displayName: copy linux runtime
    condition: eq( variables['Agent.OS'], 'Linux' )
    inputs:
      SourceFolder: '$(Build.SourcesDirectory)/packages/catalyst-ffi/target/debug'
      TargetFolder: '$./runtimes/linux-x64/native'
      Contents: 'libcatalyst_ffi.*'
  - task: DotNetCoreCLI@2
    displayName: 'restore project'
    inputs:
      command: 'restore'
      projects: '*.csproj'
      arguments: '--configuration=$(BuildConfiguration)'
      failOnStandardError: 'true'
    timeoutInMinutes: 10
  - task: DotNetCoreCLI@2
    displayName: pack project
    inputs: 
      command: 'pack'
      nobuild: false
      includesymbols: false
      includesource: false
      verbosityPack: 'Diagnostic'
      failOnStandardError: 'true'
    timeoutInMinutes: 10
  - task: PublishBuildArtifacts@1
    displayName: Publish Artifacts
    inputs:
      ArtifactName: 'catalystffi-nugets'